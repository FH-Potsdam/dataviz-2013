var allData=allData||{},variable=variable||{},projectData;jQuery(document).ready(function(){allData.project_id=6170;$.getJSON("proxy.php",{url:"https://api.startnext.de/v1/projects/"+allData.project_id},function(e){allData.project=e;loaded()});$.getJSON("proxy.php",{url:"https://api.startnext.de/v1/projects/"+allData.project_id+"/fans/?limit=999"},function(e){allData.fans=e;loaded()});$.getJSON("proxy.php",{url:"https://api.startnext.de/v1/projects/"+allData.project_id+"/fundings/?limit=999"},function(e){allData.fundings=e;loaded()});$.getJSON("proxy.php",{url:"https://api.startnext.de/v1/projects/"+allData.project_id+"/updates/?limit=999"},function(e){allData.updates=e;loaded()})});var loaded=function(){console.log("loaded");allData.fans&&allData.project&&allData.fundings&&allData.updates&&setup()},setup=function(){projectData=allData.project.contents.data[0];draw_header();draw_timeline();console.log(allData)},draw_header=function(){var e=d3.select("#widget").append("div").attr("id","widget-header");e.append("h1").html(projectData.title);e.append("h2").html(projectData.city);e.append("h3").html("Status: "+projectData.funding_status+"€");e.append("h3").html("Ziel: "+projectData.funding_target+"€");console.log(projectData)},draw_timeline=function(){var e=new Date(projectData.start_date*1e3),t=new Date(projectData.end_date*1e3),n=new Date,r=(t-e)/1e8;console.log(r+" "+(n-e)/1e8);var i=new Array,s=new Array,o=2,u=500,a=450,f=1e3,l=4,c=(1e3-r*o)/r,h=d3.scale.linear().domain([0,projectData.funding_target]).range([0,a]),p=d3.select("#widget").append("svg").attr("id","timeline-container").attr("width",f).attr("height",u);p.append("rect").attr("width",f).attr("height",u).attr("fill","#bbb");p.append("g").selectAll("rect").data(allData.fundings.contents.data).enter().append("rect").attr("x",function(t,n){var r=new Date(t.created*1e3),s=parseInt((r-e)/1e8);if(i[s]){i[s]+=1;t.pos_y=i[s]*(l+o)}else{i[s]=1;t.pos_y=i[s]*(l+o)}return s*(c+o)}).attr("y",function(e,t){return a-e.pos_y}).attr("width",c).attr("height",l);console.log(allData.updates.contents.data);p.append("g").selectAll("rect").data(allData.updates.contents.data).enter().append("rect").attr("fill","#0000ff").attr("x",function(t){var n=new Date(t.created*1e3),r=parseInt((n-e)/1e8);if(s[r]){s[r]+=1;t.pos_y=s[r]*(l+o)}else{s[r]=1;t.pos_y=s[r]*(l+o)}return r*(c+o)}).attr("y",function(e){return a+e.pos_y}).attr("width",c).attr("height",l);p.append("rect").attr("id","funding_max").attr("width",4).attr("height",a).attr("x",(n-e)/1e8*(c+o)).attr("y",0);p.append("rect").attr("id","funding_curr").attr("fill","#ff00ff").attr("width",4).attr("height",function(){return h(projectData.funding_status)}).attr("x",(n-e)/1e8*(c+o)).attr("y",function(){return a-h(projectData.funding_status)});p.append("text").attr("fill","red").attr("x",(n-e)/1e8*(c+o)+10).attr("y",function(){return a-h(projectData.funding_status)+10}).text(projectData.funding_status+"€");p.append("text").attr("fill","red").attr("x",(n-e)/1e8*(c+o)+10).attr("y",function(){return a-h(projectData.funding_target)+10}).text(projectData.funding_target+"€")};